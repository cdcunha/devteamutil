<!DOCTYPE html>
<html>
    <head>
        <title>Simple Chat with nodejs</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="js/jquery/jquery-3.2.1.min.js"></script>
		<script src="js/bootstrap/bootstrap.min.js"></script>
        <script src="js/signalr-client.js"></script>
		<link rel="stylesheet" href="css/bootstrap.min.css">
        <script type="text/javascript">
            let transportType = signalR.TransportType.WebSockets;
            let http = new signalR.HttpConnection('http://'+document.location.host+'/chat', { transport: transportType });
            let connection = new signalR.HubConnection(http);
            
			function msgTo(ID)
			{
				if (isConnected()){
					if ($("#msg").val() != ""){
                        let message = $('#msg').val();
                        let nick = $('#name').text();
                        //socketio.emit("sendTo", ID, $("#msg").val(), $("#name").val());
                        connection.invoke('SendTo', nick, message);
                        event.preventDefault();
						$("#msg").val("");
					}
				}
			}
			
			function isConnected()
			{
				/*if (!socketio.connected)
				{
					alert('Sorry, the connection was lost');
				}
				return socketio.connected;
                */
                return true;
            }

            function appendLine(nick, message, color) {
                let nameElement = document.createElement('strong');
                nameElement.innerText = '${nick}:';

                let msgElement = document.createElement('em');
                msgElement.innerText = ` ${message}`;

                let li = document.createElement('li');
                li.appendChild(nameElement);
                li.appendChild(msgElement);

                $('#messages').append(li);
            };
			
			$(document).ready(function(){
				var ready = false;
				
				$(".chat").hide();
				$("#name").focus();
				$("form").submit(function(event){
					event.preventDefault();
                });

                connection.start();

                connection.on('SendAll', (nick, message) => {
                    if (ready) {
                        $("#msgs").append("<br/>" + nick + " says: " + message + "");
                    }
                });

                connection.on('SendTo', (nick, message) => {
                    if (ready)
                        $("#msgs").append("<br/>" + message + "");
                });

                /*connection.on('Join', (nick, response) => {
                    if (ready) {
                        $("#people").empty();
                        $.each(people, function (clientid, response) {
                            $('#people').append("<br/>" + response["html"] + "");
                        });
                    }
                });*/

                connection.on("message2Me", function (nick, response) {
                    if (ready) {
                        $("#msgs").append("<br/>" + who + " says: " + msg + "");
                    }
                });

                connection.on("update", function (response) {
                    if (ready)
                        $("#msgs").append("<br/>" + response + "");
                })
				
                /*
                

					if(ready) {
						$("#people").empty();
						$.each(people, function(clientid, name) {
							$('#people').append("<br/>" + name["html"] + "");
						});
					}
				});

				socketio.on("chat", function(who, msg){
					if(ready) {
						$("#msgs").append("<br/>" + who + " says: " + msg + "");
					}
				});
				
				socketio.on('connect', function() {
					console.log('Connected');
				});
				
				socketio.on('disconnect', function () {
					console.log("Disconnected");  
				});
                */
				
				$("#join").click(function(){
                    var nick = $("#name").val();
                    if (nick != "") {
						if (isConnected()){
							connection.invoke('Join');
							$("#login").hide();//detach();
							$(".chat").show();
							$("#msg").focus();
							ready = true;
						}
					}
				});
				//If user press enter
				$("#name").keypress(function(e){
					if(e.which == 13) {
						$("#join").click();
					}
				});
				
				$("#send").click(function(){
					if (isConnected()){
                        var message = $("#msg").val();
                        if (message != "") {
                            var nick = $("#name").val();
							//socketio.emit("sendAll", msg, $("#name").val());
                            connection.invoke('SendAll', nick, message);
							$("#msg").val("");
						}
					}
				});
				//If user press enter
				$("#msg").keypress(function(e){
					if(e.which == 13) {
						$("#send").click();
					}
				});
				
				$("#logoff").click(function(){
					$("#name").val("");
					$("#msgs").empty();
					$("#people").empty();
					$("#login").show();
					$(".chat").hide();
					//socketio.disconnect();
                    connection.stop();
					location.reload(true)
				});
			})
        </script>
    </head>
    <body>
        <div class="container-fluid">
			<div class="panel panel-default">
				<div class="chat panel-heading">
					<div class="row">
						<div class="col-sm-1 span2">
						  <ul id="people" class="unstyled"></ul>
						</div>
						<div class="col-sm-11 span4">
						  <ul id="msgs" class="unstyled">
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="container-fluid">
			<div class="panel panel-default">
				<div class="panel-footer">
					<div class="row">
						<div id="login" style="height: calc(100% - 40px); overflow: auto;">
							<form class="form-inline">
								<input type="text" class="input-small" placeholder="Your name" id="name" data-toggle="tooltip" title="Type your name and press ENTER">
								<input type="button" name="join" id="join" value="Join" class="btn btn-primary">
							</form>
						</div>
						
						<div id="chat" class="chat" style="height: 40px;">
							<form id="2" class="form-inline">
								<input type="text" class="input" placeholder="Your message" id="msg" data-toggle="tooltip" title="Type your message and press ENTER to send">
								<input type="button" name="send" id="send" value="Send" class="btn btn-success">
								<input type="button" name="logoff" id="logoff" value="Disconnect" class="btn btn-danger">
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
    </body>
</html>